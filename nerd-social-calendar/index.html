<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TNS Content Calendar Planner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            overscroll-behavior-y: contain;
        }

        .modal-content::-webkit-scrollbar,
        #bulkDataInput::-webkit-scrollbar,
        #existingContributorsList::-webkit-scrollbar,
        #contributorsCheckboxesContainer::-webkit-scrollbar {
            width: 8px;
        }

        .modal-content::-webkit-scrollbar-track,
        #bulkDataInput::-webkit-scrollbar-track,
        #existingContributorsList::-webkit-scrollbar-track,
        #contributorsCheckboxesContainer::-webkit-scrollbar-track {
            background: #374151;
        }

        .modal-content::-webkit-scrollbar-thumb,
        #bulkDataInput::-webkit-scrollbar-thumb,
        #existingContributorsList::-webkit-scrollbar-thumb,
        #contributorsCheckboxesContainer::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 4px;
        }

        .modal-content::-webkit-scrollbar-thumb:hover,
        #bulkDataInput::-webkit-scrollbar-thumb:hover,
        #existingContributorsList::-webkit-scrollbar-thumb:hover,
        #contributorsCheckboxesContainer::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }

        input[type="date"]::-webkit-calendar-picker-indicator {
            filter: invert(0.8);
        }

        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #38bdf8;
            border-radius: 50%;
            width: 48px;
            height: 48px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        #contributorsCheckboxesContainer {
            max-height: 150px;
            overflow-y: auto;
            border: 1px solid #4a5568;
            padding: 0.5rem;
            border-radius: 0.5rem;
            background-color: #374151;
        }

        .film-specific-field {
            display: none;
        }

        .trailer-thumbnail-container {
            position: relative;
            cursor: pointer;
            margin-bottom: 0.75rem;
            border-radius: 0.5rem;
            overflow: hidden;
            background-color: #1f2937;
            aspect-ratio: 16 / 9;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .trailer-thumbnail-container img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: block;
        }

        .trailer-thumbnail-container .play-button-overlay {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 60px;
            height: 60px;
            background-color: rgba(0, 0, 0, 0.6);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            pointer-events: none;
        }

        .trailer-thumbnail-container .play-button-overlay svg {
            fill: white;
            width: 30px;
            height: 30px;
        }

        .embedded-trailer iframe {
            width: 100%;
            aspect-ratio: 16 / 9;
            border-radius: 0.5rem;
        }

        #dateFilterControlsContainer>div {
            margin-bottom: 0.5rem;
        }

        #dateFilterControlsContainer label {
            margin-right: 0.5rem;
        }
    </style>
</head>

<body class="bg-slate-900 text-slate-100">

    <!-- Login Screen -->
    <div id="loginScreen" class="min-h-screen flex flex-col items-center justify-center p-4">
        <h1 class="text-4xl font-bold text-sky-400">The Nerd Social Content Calendar</h1>
        <p class="text-slate-400 mt-2 mb-8">Please sign in to continue.</p>
        <button id="loginBtn"
            class="bg-white text-slate-800 font-semibold py-3 px-6 rounded-lg shadow-md flex items-center transition duration-150 ease-in-out hover:bg-slate-200">
            <svg class="w-6 h-6 mr-3" viewBox="0 0 48 48">
                <path fill="#4285F4"
                    d="M43.611 20.083H42V20H24v8h11.303c-1.649 4.657-6.08 8-11.303 8c-6.627 0-12-5.373-12-12s5.373-12 12-12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C12.955 4 4 12.955 4 24s8.955 20 20 20s20-8.955 20-20c0-1.341-.138-2.65-.389-3.917z">
                </path>
                <path fill="#34A853"
                    d="M6.306 14.691l6.571 4.819C14.655 15.108 18.961 12 24 12c3.059 0 5.842 1.154 7.961 3.039l5.657-5.657C34.046 6.053 29.268 4 24 4C16.318 4 9.656 8.337 6.306 14.691z">
                </path>
                <path fill="#FBBC05"
                    d="M24 44c5.166 0 9.86-1.977 13.412-5.192l-6.19-5.238C29.211 35.091 26.715 36 24 36c-5.202 0-9.619-3.317-11.283-7.946l-6.522 5.025C9.505 39.556 16.227 44 24 44z">
                </path>
                <path fill="#EA4335"
                    d="M43.611 20.083H42V20H24v8h11.303c-.792 2.237-2.231 4.166-4.087 5.571l6.19 5.238C42.022 36.49 44 31.28 44 24c0-1.341-.138-2.65-.389-3.917z">
                </path>
            </svg>
            Sign in with Google
        </button>
    </div>

    <!-- Main App Container -->
    <div id="appContainer" class="hidden">
        <div class="min-h-screen p-4 md:p-8">

            <header class="mb-8 text-center">
                <h1 class="text-4xl font-bold text-sky-400">The Nerd Social Content Calendar Planner</h1>
                <p class="text-slate-400 mt-2">Plan and track your YouTube review coverage for TV Shows & Films.</p>
                <div class="flex justify-center items-center mt-4">
                    <p id="userInfo" class="text-sm text-slate-300 mr-4"></p>
                    <button id="signOutBtn"
                        class="py-1 px-3 bg-slate-600 hover:bg-slate-500 text-slate-100 rounded-lg transition text-xs">Sign
                        Out</button>
                </div>
            </header>

            <div id="errorDisplay"
                class="bg-red-500 border border-red-700 text-white px-4 py-3 rounded-lg relative mb-6 shadow-lg hidden"
                role="alert">
                <strong class="font-bold"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20"
                        viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round" class="inline mr-2 h-5 w-5">
                        <path d="m21.73 18-8-14a2 2 0 0 0-3.46 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"></path>
                        <path d="M12 9v4"></path>
                        <path d="M12 17h.01"></path>
                    </svg> Error:</strong>
                <span id="errorMessage" class="block sm:inline"></span>
            </div>

            <div id="appLoader"
                class="min-h-screen bg-slate-900 flex flex-col items-center justify-center p-4 text-white fixed inset-0 z-[100] hidden">
                <div class="loader"></div>
                <p class="mt-4 text-lg">Loading App...</p>
            </div>

            <div class="mb-6 p-4 bg-slate-800 rounded-lg shadow-md flex flex-col gap-4">
                <div class="relative w-full">
                    <input type="text" id="searchTerm" placeholder="Search entries (title, network, genre)..."
                        class="w-full p-3 pl-10 bg-slate-700 border border-slate-600 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 outline-none text-slate-100 placeholder-slate-400" />
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                        class="absolute left-3 top-1/2 transform -translate-y-1/2 h-5 w-5 text-slate-400">
                        <line x1="4" y1="21" x2="4" y2="14"></line>
                        <line x1="4" y1="10" x2="4" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="12"></line>
                        <line x1="12" y1="8" x2="12" y2="3"></line>
                        <line x1="20" y1="21" x2="20" y2="16"></line>
                        <line x1="20" y1="12" x2="20" y2="3"></line>
                        <line x1="2" y1="14" x2="6" y2="14"></line>
                        <line x1="10" y1="8" x2="14" y2="8"></line>
                        <line x1="18" y1="16" x2="22" y2="16"></line>
                    </svg>
                </div>
                <div class="flex flex-wrap gap-2 justify-start">
                    <select id="filterType"
                        class="p-3 bg-slate-700 border border-slate-600 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 outline-none text-sm">
                        <option value="">All Types</option>
                        <option value="TV Show">TV Shows</option>
                        <option value="Film">Films</option>
                    </select>
                    <select id="filterStatus"
                        class="p-3 bg-slate-700 border border-slate-600 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 outline-none text-sm">
                        <option value="">All Statuses</option>
                    </select>
                    <select id="filterPriority"
                        class="p-3 bg-slate-700 border border-slate-600 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 outline-none text-sm">
                        <option value="">All Priorities</option>
                    </select>
                    <select id="filterAssignedTo"
                        class="p-3 bg-slate-700 border border-slate-600 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 outline-none text-sm">
                        <option value="">All Assigned</option>
                    </select>
                    <select id="filterPressScreeningSecured"
                        class="p-3 bg-slate-700 border border-slate-600 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 outline-none text-sm">
                        <option value="">All Press Screenings</option>
                        <option value="yes">Secured</option>
                        <option value="no">Not Secured</option>
                    </select>
                    <select id="sortOrder"
                        class="p-3 bg-slate-700 border border-slate-600 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 outline-none text-sm">
                        <option value="premiereDate">Sort by Premiere Date</option>
                        <option value="title">Sort by Title</option>
                        <option value="pressScreeningDateTime">Sort by Press Screening Date</option>
                    </select>
                </div>
                <div id="dateFilterControlsContainer"
                    class="mt-4 pt-4 border-t border-slate-700 flex flex-wrap gap-4 items-end">
                    <div><label for="dateFilterGranularity" class="block text-xs font-medium text-slate-400 mb-1">Filter
                            by Date:</label><select id="dateFilterGranularity"
                            class="p-3 bg-slate-700 border border-slate-600 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 outline-none text-sm">
                            <option value="none">None</option>
                            <option value="day">Day</option>
                            <option value="week">Week</option>
                            <option value="month">Month</option>
                            <option value="quarter">Quarter</option>
                            <option value="year">Year</option>
                        </select></div>
                    <div id="referenceDateInputContainer"><label for="dateFilterReferenceDate"
                            class="block text-xs font-medium text-slate-400 mb-1">Reference Date:</label><input
                            type="date" id="dateFilterReferenceDate"
                            class="p-2.5 bg-slate-700 border border-slate-600 rounded-lg focus:ring-1 focus:ring-sky-500 focus:border-sky-500 outline-none appearance-none text-sm">
                    </div>
                    <div><label for="dateFilterRelation"
                            class="block text-xs font-medium text-slate-400 mb-1">Relation:</label><select
                            id="dateFilterRelation"
                            class="p-3 bg-slate-700 border border-slate-600 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 outline-none text-sm">
                            <option value="during">During</option>
                            <option value="before">Before</option>
                            <option value="after">After</option>
                        </select></div>
                    <button id="clearDateFilterBtn"
                        class="p-3 bg-slate-600 hover:bg-slate-500 text-white rounded-lg text-sm">Clear Date
                        Filter</button>
                </div>

                <div class="flex gap-2 w-full justify-center md:justify-end mt-4">
                    <button id="manageContributorsBtn"
                        class="flex items-center justify-center bg-indigo-500 hover:bg-indigo-600 text-white font-semibold py-2 px-3 rounded-lg shadow-md transition duration-150 ease-in-out text-xs">Manage
                        Contributors</button>
                    <button id="bulkAddBtn"
                        class="flex items-center justify-center bg-teal-500 hover:bg-teal-600 text-white font-semibold py-2 px-3 rounded-lg shadow-md transition duration-150 ease-in-out text-xs">Import
                        Entries</button>
                    <button id="exportDataBtn"
                        class="flex items-center justify-center bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-3 rounded-lg shadow-md transition duration-150 ease-in-out text-xs"><svg
                            xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                            class="mr-1 h-4 w-4">
                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                            <polyline points="7 10 12 15 17 10"></polyline>
                            <line x1="12" y1="15" x2="12" y2="3"></line>
                        </svg>Export Data</button>
                    <button id="addShowBtn"
                        class="flex items-center justify-center bg-sky-500 hover:bg-sky-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-150 ease-in-out text-xs"><svg
                            xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                            class="mr-1 h-4 w-4">
                            <circle cx="12" cy="12" r="10"></circle>
                            <line x1="12" y1="8" x2="12" y2="16"></line>
                            <line x1="8" y1="12" x2="16" y2="12"></line>
                        </svg>Add Entry</button>
                </div>
            </div>

            <div id="showsLoader" class="hidden">
                <div class="loader"></div>
                <p class="mt-4 text-lg text-slate-300 text-center">Loading entries...</p>
            </div>
            <div id="noShowsMessage" class="text-center py-10 bg-slate-800 rounded-lg shadow hidden">
                <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                    class="mx-auto h-16 w-16 text-slate-500 mb-4">
                    <rect width="20" height="15" x="2" y="7" rx="2" ry="2"></rect>
                    <polyline points="17 2 12 7 7 2"></polyline>
                </svg>
                <p class="text-xl text-slate-300">No entries match your current filters or no entries added yet.</p>
                <p class="text-slate-400 mt-2">Try adjusting your search or filters, or add a new entry!</p>
            </div>
            <div id="showsGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>

            <!-- MODALS -->
            <div id="showModal"
                class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 backdrop-blur-sm hidden">
                <div
                    class="bg-slate-800 p-6 md:p-8 rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-y-auto modal-content">
                    <h2 id="modalTitle" class="text-2xl font-semibold mb-6 text-sky-400">Add New Entry</h2>
                    <div id="modalErrorMessage"
                        class="bg-red-100 border border-red-400 text-red-700 px-4 py-2 rounded-md mb-4 hidden"></div>
                    <form id="showForm" class="space-y-4">
                        <input type="hidden" id="showId" name="id">
                        <div><label for="entryType" class="block text-sm font-medium text-slate-300 mb-1">Entry Type
                                *</label><select name="entryType" id="entryType" required
                                class="w-full p-2.5 bg-slate-700 border border-slate-600 rounded-lg focus:ring-1 focus:ring-sky-500 focus:border-sky-500 outline-none">
                                <option value="TV Show">TV Show</option>
                                <option value="Film">Film</option>
                            </select></div>
                        <div><label for="title" class="block text-sm font-medium text-slate-300 mb-1">Title
                                *</label><input type="text" name="title" id="title" required
                                class="w-full p-2.5 bg-slate-700 border border-slate-600 rounded-lg focus:ring-1 focus:ring-sky-500 focus:border-sky-500 outline-none">
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div><label for="networkPlatform"
                                    class="block text-sm font-medium text-slate-300 mb-1">Network/Platform/Distributor</label><input
                                    type="text" name="networkPlatform" id="networkPlatform"
                                    class="w-full p-2.5 bg-slate-700 border border-slate-600 rounded-lg focus:ring-1 focus:ring-sky-500 focus:border-sky-500 outline-none">
                            </div>
                            <div><label for="premiereDate"
                                    class="block text-sm font-medium text-slate-300 mb-1">Premiere/Release Date
                                    *</label><input type="date" name="premiereDate" id="premiereDate" required
                                    class="w-full p-2.5 bg-slate-700 border border-slate-600 rounded-lg focus:ring-1 focus:ring-sky-500 focus:border-sky-500 outline-none appearance-none">
                            </div>
                        </div>
                        <div><label for="trailerLink" class="block text-sm font-medium text-slate-300 mb-1">Trailer Link
                                (YouTube)</label><input type="url" name="trailerLink" id="trailerLink"
                                class="w-full p-2.5 bg-slate-700 border border-slate-600 rounded-lg focus:ring-1 focus:ring-sky-500 focus:border-sky-500 outline-none">
                        </div>
                        <div><label for="genre"
                                class="block text-sm font-medium text-slate-300 mb-1">Genre(s)</label><input type="text"
                                name="genre" id="genre"
                                class="w-full p-2.5 bg-slate-700 border border-slate-600 rounded-lg focus:ring-1 focus:ring-sky-500 focus:border-sky-500 outline-none">
                        </div>
                        <div><label for="keyIPSource" class="block text-sm font-medium text-slate-300 mb-1">Key IP
                                Source</label><input type="text" name="keyIPSource" id="keyIPSource"
                                class="w-full p-2.5 bg-slate-700 border border-slate-600 rounded-lg focus:ring-1 focus:ring-sky-500 focus:border-sky-500 outline-none">
                        </div>
                        <div><label for="description"
                                class="block text-sm font-medium text-slate-300 mb-1">Description/Synopsis</label><textarea
                                name="description" id="description" rows="3"
                                class="w-full p-2.5 bg-slate-700 border border-slate-600 rounded-lg focus:ring-1 focus:ring-sky-500 focus:border-sky-500 outline-none"></textarea>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div><label for="reviewStatus" class="block text-sm font-medium text-slate-300 mb-1">Review
                                    Status</label><select name="reviewStatus" id="reviewStatus"
                                    class="w-full p-2.5 bg-slate-700 border border-slate-600 rounded-lg focus:ring-1 focus:ring-sky-500 focus:border-sky-500 outline-none"></select>
                            </div>
                            <div><label for="coveragePriority"
                                    class="block text-sm font-medium text-slate-300 mb-1">Coverage
                                    Priority</label><select name="coveragePriority" id="coveragePriority"
                                    class="w-full p-2.5 bg-slate-700 border border-slate-600 rounded-lg focus:ring-1 focus:ring-sky-500 focus:border-sky-500 outline-none"></select>
                            </div>
                        </div>
                        <div id="tvScreenerFields" class="space-y-2">
                            <div class="flex items-center"><input type="checkbox" name="screenerRequested"
                                    id="screenerRequested"
                                    class="h-4 w-4 text-sky-600 border-slate-500 rounded focus:ring-sky-500"><label
                                    for="screenerRequested" class="ml-2 block text-sm text-slate-300">Screener Link
                                    Requested?</label></div>
                            <div id="screenerRequestedDateContainer" class="hidden"><label for="screenerRequestedDate"
                                    class="block text-sm font-medium text-slate-300 mb-1">Requested Date</label><input
                                    type="date" name="screenerRequestedDate" id="screenerRequestedDate"
                                    class="w-full p-2.5 bg-slate-700 border border-slate-600 rounded-lg focus:ring-1 focus:ring-sky-500 focus:border-sky-500 outline-none appearance-none">
                            </div>
                            <div class="flex items-center mt-2"><input type="checkbox" name="screenerReceived"
                                    id="screenerReceived"
                                    class="h-4 w-4 text-sky-600 border-slate-500 rounded focus:ring-sky-500"><label
                                    for="screenerReceived" class="ml-2 block text-sm text-slate-300">Screener Link
                                    Received?</label></div>
                            <div id="screenerReceivedDateContainer" class="hidden"><label for="screenerReceivedDate"
                                    class="block text-sm font-medium text-slate-300 mb-1">Received Date</label><input
                                    type="date" name="screenerReceivedDate" id="screenerReceivedDate"
                                    class="w-full p-2.5 bg-slate-700 border border-slate-600 rounded-lg focus:ring-1 focus:ring-sky-500 focus:border-sky-500 outline-none appearance-none">
                            </div>
                        </div>
                        <div id="filmPressScreeningFields" class="space-y-2 film-specific-field">
                            <div class="flex items-center"><input type="checkbox"
                                    name="pressScreeningAttendanceRequested" id="pressScreeningAttendanceRequested"
                                    class="h-4 w-4 text-sky-600 border-slate-500 rounded focus:ring-sky-500"><label
                                    for="pressScreeningAttendanceRequested"
                                    class="ml-2 block text-sm text-slate-300">Attendance Requested?</label></div>
                            <div id="pressScreeningRequestDateContainer" class="hidden"><label
                                    for="pressScreeningRequestDate"
                                    class="block text-sm font-medium text-slate-300 mb-1">Request Date</label><input
                                    type="date" name="pressScreeningRequestDate" id="pressScreeningRequestDate"
                                    class="w-full p-2.5 bg-slate-700 border border-slate-600 rounded-lg focus:ring-1 focus:ring-sky-500 focus:border-sky-500 outline-none appearance-none">
                            </div>
                            <div class="flex items-center mt-2"><input type="checkbox" name="pressScreeningSecured"
                                    id="pressScreeningSecured"
                                    class="h-4 w-4 text-sky-600 border-slate-500 rounded focus:ring-sky-500"><label
                                    for="pressScreeningSecured" class="ml-2 block text-sm text-slate-300">Screening
                                    Secured?</label></div>
                            <div id="pressScreeningDateTimeContainer" class="hidden"><label for="pressScreeningDateTime"
                                    class="block text-sm font-medium text-slate-300 mb-1">Screening Date</label><input
                                    type="date" name="pressScreeningDateTime" id="pressScreeningDateTime"
                                    class="w-full p-2.5 bg-slate-700 border border-slate-600 rounded-lg focus:ring-1 focus:ring-sky-500 focus:border-sky-500 outline-none appearance-none">
                            </div>
                        </div>
                        <div><label for="assignedTo" class="block text-sm font-medium text-slate-300 mb-1">Assigned To
                                (Lead)</label><input type="text" name="assignedTo" id="assignedTo"
                                class="w-full p-2.5 bg-slate-700 border border-slate-600 rounded-lg focus:ring-1 focus:ring-sky-500 focus:border-sky-500 outline-none">
                        </div>
                        <div><label for="reviewProducer" class="block text-sm font-medium text-slate-300 mb-1">Review
                                Producer</label><input type="text" name="reviewProducer" id="reviewProducer"
                                class="w-full p-2.5 bg-slate-700 border border-slate-600 rounded-lg focus:ring-1 focus:ring-sky-500 focus:border-sky-500 outline-none">
                        </div>
                        <div><label class="block text-sm font-medium text-slate-300 mb-1">Contributors (Critics)</label>
                            <div id="contributorsCheckboxesContainer" class="space-y-1"></div>
                        </div>
                        <div><label for="notes"
                                class="block text-sm font-medium text-slate-300 mb-1">Notes</label><textarea
                                name="notes" id="notes" rows="3"
                                class="w-full p-2.5 bg-slate-700 border border-slate-600 rounded-lg focus:ring-1 focus:ring-sky-500 focus:border-sky-500 outline-none"></textarea>
                        </div>
                        <div><label for="youtubeLink" class="block text-sm font-medium text-slate-300 mb-1">YouTube Link
                                (Published)</label><input type="url" name="youtubeLink" id="youtubeLink"
                                class="w-full p-2.5 bg-slate-700 border border-slate-600 rounded-lg focus:ring-1 focus:ring-sky-500 focus:border-sky-500 outline-none">
                        </div>
                        <div class="flex justify-end gap-4 pt-4"><button type="button" id="cancelModalBtn"
                                class="py-2 px-4 bg-slate-600 hover:bg-slate-500 text-slate-100 rounded-lg transition">Cancel</button><button
                                type="submit"
                                class="py-2 px-6 bg-sky-500 hover:bg-sky-600 text-white font-semibold rounded-lg transition">Save
                                Entry</button></div>
                    </form>
                </div>
            </div>
            <div id="confirmationModal"
                class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-[60] backdrop-blur-sm hidden">
                <div class="bg-slate-800 p-6 rounded-xl shadow-2xl w-full max-w-md">
                    <h3 id="confirmationTitle" class="text-xl font-semibold mb-4 text-sky-400">Confirm Action</h3>
                    <p id="confirmationMessage" class="text-slate-300 mb-6">Are you sure?</p>
                    <div class="flex justify-end gap-4"><button id="cancelConfirmBtn"
                            class="py-2 px-4 bg-slate-600 hover:bg-slate-500 text-slate-100 rounded-lg transition">Cancel</button><button
                            id="confirmActionBtn"
                            class="py-2 px-4 bg-red-500 hover:bg-red-600 text-white rounded-lg transition">Confirm</button>
                    </div>
                </div>
            </div>
            <div id="contributorManagementModal"
                class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-[70] backdrop-blur-sm hidden">
                <div class="bg-slate-800 p-6 md:p-8 rounded-xl shadow-2xl w-full max-w-lg modal-content">
                    <h2 class="text-2xl font-semibold mb-6 text-sky-400">Manage Contributors</h2>
                    <div class="mb-4"><label for="newContributorName"
                            class="block text-sm font-medium text-slate-300 mb-1">New Contributor Name</label>
                        <div class="flex gap-2"><input type="text" id="newContributorName" placeholder="Enter name..."
                                class="flex-grow p-2.5 bg-slate-700 border border-slate-600 rounded-lg focus:ring-1 focus:ring-sky-500 focus:border-sky-500 outline-none"><button
                                id="addContributorBtn"
                                class="py-2 px-4 bg-sky-500 hover:bg-sky-600 text-white font-semibold rounded-lg transition">Add</button>
                        </div>
                    </div>
                    <h3 class="text-lg font-medium text-slate-300 mb-2">Existing Contributors</h3>
                    <div id="existingContributorsList"
                        class="space-y-2 max-h-60 overflow-y-auto p-2 bg-slate-700 border border-slate-600 rounded-lg">
                    </div>
                    <div class="flex justify-end mt-6"><button id="closeContributorModalBtn"
                            class="py-2 px-4 bg-slate-600 hover:bg-slate-500 text-slate-100 rounded-lg transition">Close</button>
                    </div>
                </div>
            </div>
            <div id="bulkAddModal"
                class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-[70] backdrop-blur-sm hidden">
                <div class="bg-slate-800 p-6 md:p-8 rounded-xl shadow-2xl w-full max-w-2xl modal-content">
                    <h2 class="text-2xl font-semibold mb-6 text-sky-400">Bulk Import Entries</h2>
                    <p class="text-sm text-slate-400 mb-2">Paste an array of entry objects in JSON format below.</p>
                    <p class="text-xs text-slate-500 mb-4">This will add new entries to the database, it will not
                        overwrite existing ones.</p><textarea id="bulkDataInput" rows="10"
                        class="w-full p-2.5 bg-slate-700 border border-slate-600 rounded-lg focus:ring-1 focus:ring-sky-500 focus:border-sky-500 outline-none mb-4"
                        placeholder="Paste JSON array here..."></textarea>
                    <div id="bulkAddStatus" class="text-sm mb-4"></div>
                    <div class="flex justify-end gap-4"><button id="closeBulkAddModalBtn"
                            class="py-2 px-4 bg-slate-600 hover:bg-slate-500 text-slate-100 rounded-lg transition">Close</button><button
                            id="importBulkDataBtn"
                            class="py-2 px-6 bg-teal-500 hover:bg-teal-600 text-white font-semibold rounded-lg transition">Import
                            Entries</button></div>
                </div>
            </div>

            <footer class="text-center mt-12 py-4 border-t border-slate-700">
                <p id="appInfoDisplay" class="text-sm text-slate-500">Â© <span id="currentYear"></span> Content Calendar
                    Planner. Data stored in the cloud.</p>
            </footer>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore-compat.js"></script>

    <script>
        // --- Firebase Initialization ---
        const firebaseConfig = {
            apiKey: "AIzaSyAwD9xuNDaIjJYv6vnL6p5Z4GxsQp90UOQ",
            authDomain: "nerd-social-calendar.firebaseapp.com",
            projectId: "nerd-social-calendar",
            storageBucket: "nerd-social-calendar.firebasestorage.app",
            messagingSenderId: "57805491361",
            appId: "1:57805491361:web:c6758064e63000edd4f4e0"
        };

        const app = firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // --- Global State ---
        let allEntries = [];
        let allContributors = [];
        let currentUserRole = 'viewer';
        let unsubscribeEntries = null;
        let unsubscribeContributors = null;

        const reviewStatuses = ["Not Started", "Planning", "Researching", "Scripting", "Filming", "Editing", "Scheduled", "Published", "Skipped"];
        const coveragePriorities = ["High", "Medium", "Low"];

        // --- DOM Elements ---
        const loginScreenEl = document.getElementById('loginScreen');
        const loginBtnEl = document.getElementById('loginBtn');
        const appContainerEl = document.getElementById('appContainer');
        const userInfoEl = document.getElementById('userInfo');
        const signOutBtnEl = document.getElementById('signOutBtn');
        const bulkAddBtnEl = document.getElementById('bulkAddBtn');
        const bulkAddModalEl = document.getElementById('bulkAddModal');
        const bulkDataInputEl = document.getElementById('bulkDataInput');
        const importBulkDataBtnEl = document.getElementById('importBulkDataBtn');
        const closeBulkAddModalBtnEl = document.getElementById('closeBulkAddModalBtn');
        const bulkAddStatusEl = document.getElementById('bulkAddStatus');
        const exportDataBtnEl = document.getElementById('exportDataBtn');
        const showsGridEl = document.getElementById('showsGrid');
        const addShowBtnEl = document.getElementById('addShowBtn');
        const showModalEl = document.getElementById('showModal');
        const showFormEl = document.getElementById('showForm');
        const cancelModalBtnEl = document.getElementById('cancelModalBtn');
        const modalTitleEl = document.getElementById('modalTitle');
        const modalErrorMessageEl = document.getElementById('modalErrorMessage');
        const errorDisplayEl = document.getElementById('errorDisplay');
        const errorMessageContentEl = document.getElementById('errorMessage');
        const appLoaderEl = document.getElementById('appLoader');
        const showsLoaderEl = document.getElementById('showsLoader');
        const noShowsMessageEl = document.getElementById('noShowsMessage');
        const searchTermInputEl = document.getElementById('searchTerm');
        const filterTypeSelectEl = document.getElementById('filterType');
        const filterStatusSelectEl = document.getElementById('filterStatus');
        const filterPrioritySelectEl = document.getElementById('filterPriority');
        const filterAssignedToSelectEl = document.getElementById('filterAssignedTo');
        const filterPressScreeningSecuredEl = document.getElementById('filterPressScreeningSecured');
        const sortOrderSelectEl = document.getElementById('sortOrder');
        const dateFilterGranularityEl = document.getElementById('dateFilterGranularity');
        const dateFilterReferenceDateEl = document.getElementById('dateFilterReferenceDate');
        const dateFilterRelationEl = document.getElementById('dateFilterRelation');
        const clearDateFilterBtnEl = document.getElementById('clearDateFilterBtn');
        const referenceDateInputContainerEl = document.getElementById('referenceDateInputContainer');
        const confirmationModalEl = document.getElementById('confirmationModal');
        const confirmationTitleEl = document.getElementById('confirmationTitle');
        const confirmationMessageEl = document.getElementById('confirmationMessage');
        const confirmActionBtnEl = document.getElementById('confirmActionBtn');
        const cancelConfirmBtnEl = document.getElementById('cancelConfirmBtn');
        let currentDeleteEntryId = null;
        let currentDeleteContributorId = null;
        const manageContributorsBtnEl = document.getElementById('manageContributorsBtn');
        const contributorManagementModalEl = document.getElementById('contributorManagementModal');
        const newContributorNameInputEl = document.getElementById('newContributorName');
        const addContributorBtnEl = document.getElementById('addContributorBtn');
        const existingContributorsListEl = document.getElementById('existingContributorsList');
        const closeContributorModalBtnEl = document.getElementById('closeContributorModalBtn');
        const contributorsCheckboxesContainerEl = document.getElementById('contributorsCheckboxesContainer');
        const tvScreenerFieldsEl = document.getElementById('tvScreenerFields');
        const filmPressScreeningFieldsEl = document.getElementById('filmPressScreeningFields');
        const screenerRequestedDateContainerEl = document.getElementById('screenerRequestedDateContainer');
        const screenerReceivedDateContainerEl = document.getElementById('screenerReceivedDateContainer');
        const pressScreeningRequestDateContainerEl = document.getElementById('pressScreeningRequestDateContainer');
        const pressScreeningDateTimeContainerEl = document.getElementById('pressScreeningDateTimeContainer');

        // --- Authentication & Authorization ---
        loginBtnEl.addEventListener('click', () => {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider).catch(error => {
                console.error("Authentication error:", error);
                displayError(`Authentication failed: ${error.message}`);
            });
        });

        signOutBtnEl.addEventListener('click', () => { auth.signOut(); });

        auth.onAuthStateChanged(async user => {
            if (user) {
                appLoaderEl.classList.remove('hidden');
                const userDocRef = db.collection('authorized_users').doc(user.email);
                const userDoc = await userDocRef.get();

                if (userDoc.exists) {
                    const userData = userDoc.data();
                    currentUserRole = userData.role || 'viewer';

                    console.log(`User ${user.email} authenticated. Role: ${currentUserRole}.`);
                    userInfoEl.textContent = `Signed in as ${user.displayName || user.email} (${currentUserRole})`;
                    loginScreenEl.classList.add('hidden');
                    appContainerEl.classList.remove('hidden');

                    initializeAppUI();
                    listenForDataChanges();
                } else {
                    currentUserRole = 'viewer';
                    console.warn(`User ${user.email} authenticated but NOT authorized.`);
                    loginScreenEl.innerHTML = `<h1 class="text-3xl font-bold text-red-500">Access Denied</h1><p class="text-slate-300 mt-2">Your account (${user.email}) is not authorized to use this application.</p><p class="text-slate-400 mt-1">Please contact the administrator.</p><button onclick="auth.signOut()" class="mt-8 py-2 px-4 bg-slate-600 hover:bg-slate-500 rounded-lg">Sign Out</button>`;
                    loginScreenEl.classList.remove('hidden');
                    appContainerEl.classList.add('hidden');
                    auth.signOut();
                }
                appLoaderEl.classList.add('hidden');
            } else {
                console.log("No user signed in.");
                loginScreenEl.classList.remove('hidden');
                appContainerEl.classList.add('hidden');
                if (unsubscribeEntries) unsubscribeEntries();
                if (unsubscribeContributors) unsubscribeContributors();
            }
        });

        // --- Real-time Data Listeners ---
        function listenForDataChanges() {
            if (unsubscribeEntries) unsubscribeEntries();
            if (unsubscribeContributors) unsubscribeContributors();

            showsLoaderEl.classList.remove('hidden');
            unsubscribeEntries = db.collection('entries').onSnapshot(snapshot => {
                allEntries = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderEntries();
                showsLoaderEl.classList.add('hidden');
            }, error => {
                console.error("Error listening to entries:", error);
                displayError("Could not load calendar entries from the database.");
                showsLoaderEl.classList.add('hidden');
            });

            unsubscribeContributors = db.collection('contributors').onSnapshot(snapshot => {
                allContributors = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                if (!showModalEl.classList.contains('hidden')) {
                    const selectedContributors = Array.from(document.querySelectorAll('#contributorsCheckboxesContainer input:checked')).map(cb => cb.value);
                    renderContributorCheckboxesInShowModal(selectedContributors);
                }
                if (!contributorManagementModalEl.classList.contains('hidden')) {
                    renderContributorsInManagementModal();
                }
            }, error => {
                console.error("Error listening to contributors:", error);
                displayError("Could not load contributors from the database.");
            });
        }

        // --- DATA IMPORT / EXPORT ---
        function handleExportData() {
            try {
                const dataToExport = {
                    version: '3.0-firestore',
                    exportedAt: new Date().toISOString(),
                    entries: allEntries.map(e => { const copy = { ...e }; delete copy.id; return copy; }),
                    contributors: allContributors.map(c => { const copy = { ...c }; delete copy.id; return copy; })
                };
                const jsonString = JSON.stringify(dataToExport, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                const date = new Date();
                const dateString = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
                a.download = `content-planner-backup-${dateString}.json`;
                a.href = url;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            } catch (error) {
                displayError("Error exporting data: " + error.message);
            }
        }

        function openBulkAddModal() {
            bulkDataInputEl.value = '';
            bulkAddStatusEl.textContent = '';
            bulkAddStatusEl.className = 'text-sm mb-4';
            bulkAddModalEl.classList.remove('hidden');
        }

        function closeBulkAddModal() {
            bulkAddModalEl.classList.add('hidden');
        }

        function handleBulkAdd() {
            const jsonData = bulkDataInputEl.value.trim();
            if (!jsonData) {
                bulkAddStatusEl.textContent = "Input is empty.";
                bulkAddStatusEl.className = 'text-sm mb-4 text-yellow-400';
                return;
            }
            try {
                const parsedData = JSON.parse(jsonData);
                const entriesToImport = parsedData.entries || parsedData;

                if (!Array.isArray(entriesToImport)) {
                    throw new Error("Input must be a JSON array of entry objects or a backup file with an 'entries' property.");
                }

                let addedCount = 0;
                let failedCount = 0;
                const batch = db.batch();

                entriesToImport.forEach(entry => {
                    if (entry && entry.title && entry.premiereDate && entry.type) {
                        const docRef = db.collection('entries').doc();
                        batch.set(docRef, { ...entry, createdAt: firebase.firestore.FieldValue.serverTimestamp() });
                        addedCount++;
                    } else {
                        failedCount++;
                    }
                });

                batch.commit().then(() => {
                    bulkAddStatusEl.textContent = `${addedCount} entries added successfully. ${failedCount} entries failed.`;
                    bulkAddStatusEl.className = `text-sm mb-4 ${failedCount > 0 ? 'text-yellow-400' : 'text-green-400'}`;
                    if (addedCount > 0 && failedCount === 0) {
                        setTimeout(closeBulkAddModal, 2000);
                    }
                }).catch(error => {
                    bulkAddStatusEl.textContent = "Error importing data: " + error.message;
                    bulkAddStatusEl.className = 'text-sm mb-4 text-red-400';
                });
            } catch (error) {
                bulkAddStatusEl.textContent = "Error: Invalid JSON format. " + error.message;
                bulkAddStatusEl.className = 'text-sm mb-4 text-red-400';
            }
        }

        // --- Firestore CRUD Functions ---
        function addContributor() {
            const name = newContributorNameInputEl.value.trim();
            if (name && !allContributors.find(c => c.name.toLowerCase() === name.toLowerCase())) {
                db.collection('contributors').add({ name })
                    .then(() => { newContributorNameInputEl.value = ''; })
                    .catch(error => displayError(`Failed to add contributor: ${error.message}`));
            }
        }

        function deleteContributor(id) {
            db.collection('contributors').doc(id).delete()
                .catch(error => displayError(`Failed to delete contributor: ${error.message}`));
        }

        function handleEditEntry(entryId) {
            openModal(entryId);
        }

        function handleDeleteEntry(id) {
            db.collection('entries').doc(id).delete()
                .catch(error => displayError(`Failed to delete entry: ${error.message}`));
        }

        showFormEl.addEventListener('submit', (e) => {
            e.preventDefault();
            const formData = new FormData(showFormEl);
            const entryDataFromForm = Object.fromEntries(formData.entries());

            entryDataFromForm.screenerRequested = document.getElementById('screenerRequested').checked;
            entryDataFromForm.screenerReceived = document.getElementById('screenerReceived').checked;
            entryDataFromForm.pressScreeningAttendanceRequested = document.getElementById('pressScreeningAttendanceRequested').checked;
            entryDataFromForm.pressScreeningSecured = document.getElementById('pressScreeningSecured').checked;

            const selectedContributors = [];
            document.querySelectorAll('#contributorsCheckboxesContainer input[name="contributors"]:checked').forEach(checkbox => {
                selectedContributors.push(checkbox.value);
            });
            entryDataFromForm.contributors = selectedContributors;

            if (entryDataFromForm.entryType === "TV Show") {
                delete entryDataFromForm.pressScreeningAttendanceRequested;
                delete entryDataFromForm.pressScreeningRequestDate;
                delete entryDataFromForm.pressScreeningSecured;
                delete entryDataFromForm.pressScreeningDateTime;
            } else if (entryDataFromForm.entryType === "Film") {
                delete entryDataFromForm.screenerRequested;
                delete entryDataFromForm.screenerRequestedDate;
                delete entryDataFromForm.screenerReceived;
                delete entryDataFromForm.screenerReceivedDate;
            }
            if (!entryDataFromForm.title || !entryDataFromForm.premiereDate) {
                modalErrorMessageEl.textContent = "Title and Premiere/Release Date are required.";
                modalErrorMessageEl.classList.remove('hidden');
                return;
            }
            modalErrorMessageEl.classList.add('hidden');

            const entryId = entryDataFromForm.id;
            delete entryDataFromForm.id;

            if (entryId) {
                entryDataFromForm.updatedAt = firebase.firestore.FieldValue.serverTimestamp();
                db.collection('entries').doc(entryId).update(entryDataFromForm)
                    .then(() => { closeModal(); })
                    .catch(error => {
                        modalErrorMessageEl.textContent = `Update failed: ${error.message}`;
                        modalErrorMessageEl.classList.remove('hidden');
                    });
            } else {
                entryDataFromForm.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                db.collection('entries').add(entryDataFromForm)
                    .then(() => { closeModal(); })
                    .catch(error => {
                        modalErrorMessageEl.textContent = `Save failed: ${error.message}`;
                        modalErrorMessageEl.classList.remove('hidden');
                    });
            }
        });

        // --- All other UI and helper functions remain the same ---
        function displayError(message) {
            errorMessageContentEl.textContent = message;
            errorDisplayEl.classList.remove('hidden');
            console.error("Displaying Error:", message);
        }
        function clearError() {
            errorDisplayEl.classList.add('hidden');
            errorMessageContentEl.textContent = '';
        }
        function formatDate(dateString) {
            if (!dateString) return 'N/A';
            try {
                const date = new Date(dateString + 'T00:00:00');
                if (isNaN(date.getTime())) return dateString;
                return date.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
            } catch (e) {
                console.warn("Error formatting date:", dateString, e);
                return dateString;
            }
        }
        function getStartOfWeek(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? -6 : 1);
            return new Date(d.setDate(diff));
        }
        function getEndOfWeek(date) {
            const d = new Date(date);
            const day = d.getDay();
            const diff = d.getDate() - day + (day === 0 ? 0 : 7);
            return new Date(d.setDate(diff));
        }
        function populateDropdown(selectElement, options, addDefaultAll = true, defaultText = null) {
            const currentValue = selectElement.value;
            selectElement.innerHTML = '';
            if (addDefaultAll) {
                const defaultOption = document.createElement('option');
                defaultOption.value = "";
                defaultOption.textContent = defaultText || 'All';
                selectElement.appendChild(defaultOption);
            }
            options.forEach(optionValue => {
                const option = document.createElement('option');
                option.value = optionValue;
                option.textContent = optionValue;
                selectElement.appendChild(option);
            });
            if (options.includes(currentValue)) {
                selectElement.value = currentValue;
            }
        }
        function openConfirmationModal(title, message, onConfirmCallback) {
            confirmationTitleEl.textContent = title;
            confirmationMessageEl.textContent = message;
            confirmationModalEl.classList.remove('hidden');
            const newConfirmBtn = confirmActionBtnEl.cloneNode(true);
            confirmActionBtnEl.parentNode.replaceChild(newConfirmBtn, confirmActionBtnEl);
            document.getElementById('confirmActionBtn').onclick = () => {
                onConfirmCallback();
                closeConfirmationModal();
            };
        }
        function closeConfirmationModal() {
            confirmationModalEl.classList.add('hidden');
        }
        function getYouTubeVideoId(url) {
            if (!url) return null;
            let videoId = null;
            try {
                const parsedUrl = new URL(url);
                if (parsedUrl.hostname.includes('youtube.com')) {
                    videoId = parsedUrl.searchParams.get('v');
                } else if (parsedUrl.hostname === 'youtu.be') {
                    videoId = parsedUrl.pathname.substring(1);
                }
            } catch (e) {
                return null;
            }
            return videoId;
        }
        function toggleModalSpecificFields(entryType) {
            if (entryType === 'Film') {
                tvScreenerFieldsEl.style.display = 'none';
                filmPressScreeningFieldsEl.style.display = 'block';
            } else {
                tvScreenerFieldsEl.style.display = 'block';
                filmPressScreeningFieldsEl.style.display = 'none';
            }
        }
        function renderContributorCheckboxesInShowModal(selectedContributorNames = []) {
            contributorsCheckboxesContainerEl.innerHTML = '';
            if (allContributors.length === 0) {
                contributorsCheckboxesContainerEl.innerHTML = '<p class="text-slate-400 text-sm">No contributors added yet.</p>';
                return;
            }
            allContributors.forEach(contributor => {
                const div = document.createElement('div');
                div.className = 'flex items-center';
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = `contrib-modal-${contributor.id}`;
                checkbox.name = 'contributors';
                checkbox.value = contributor.name;
                checkbox.className = 'h-4 w-4 text-sky-600 border-slate-500 rounded focus:ring-sky-500';
                if (selectedContributorNames.includes(contributor.name)) {
                    checkbox.checked = true;
                }
                const label = document.createElement('label');
                label.htmlFor = `contrib-modal-${contributor.id}`;
                label.textContent = contributor.name;
                label.className = 'ml-2 block text-sm text-slate-300';
                div.appendChild(checkbox);
                div.appendChild(label);
                contributorsCheckboxesContainerEl.appendChild(div);
            });
        }
        function openModal(entryId = null) {
            showFormEl.reset();
            modalErrorMessageEl.classList.add('hidden');
            modalErrorMessageEl.textContent = '';
            const entry = entryId ? allEntries.find(e => e.id === entryId) : null;
            const defaultEntryData = { type: "TV Show", trailerLink: "", screenerRequested: false, screenerRequestedDate: "", screenerReceived: false, screenerReceivedDate: "", pressScreeningAttendanceRequested: false, pressScreeningRequestDate: "", pressScreeningSecured: false, pressScreeningDateTime: "", reviewProducer: "", contributors: [], reviewStatus: "Not Started", coveragePriority: "Medium", assignedTo: "", notes: "", youtubeLink: "" };
            const currentEntryData = entry ? { ...defaultEntryData, ...entry } : { ...defaultEntryData };
            if (entry) {
                modalTitleEl.textContent = 'Edit Entry';
                document.getElementById('showId').value = currentEntryData.id || '';
            } else {
                modalTitleEl.textContent = 'Add New Entry';
                document.getElementById('showId').value = '';
            }
            Object.keys(currentEntryData).forEach(key => {
                const el = document.getElementById(key);
                if (el) {
                    if (el.type === 'checkbox') {
                        el.checked = currentEntryData[key];
                    } else {
                        el.value = currentEntryData[key] || '';
                    }
                }
            });
            toggleModalSpecificFields(document.getElementById('entryType').value);
            screenerRequestedDateContainerEl.classList.toggle('hidden', !document.getElementById('screenerRequested').checked);
            screenerReceivedDateContainerEl.classList.toggle('hidden', !document.getElementById('screenerReceived').checked);
            pressScreeningRequestDateContainerEl.classList.toggle('hidden', !document.getElementById('pressScreeningAttendanceRequested').checked);
            pressScreeningDateTimeContainerEl.classList.toggle('hidden', !document.getElementById('pressScreeningSecured').checked);
            renderContributorCheckboxesInShowModal(currentEntryData.contributors || []);
            showModalEl.classList.remove('hidden');
        }
        function closeModal() {
            showModalEl.classList.add('hidden');
        }
        function renderContributorsInManagementModal() {
            existingContributorsListEl.innerHTML = '';
            if (allContributors.length === 0) {
                existingContributorsListEl.innerHTML = '<p class="text-slate-400 text-sm">No contributors added yet.</p>';
                return;
            }
            allContributors.forEach(contributor => {
                const div = document.createElement('div');
                div.className = 'flex justify-between items-center p-2 bg-slate-600 rounded';
                const nameSpan = document.createElement('span');
                nameSpan.textContent = contributor.name;
                nameSpan.className = 'text-slate-100';
                const deleteBtn = document.createElement('button');
                deleteBtn.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-red-400 hover:text-red-300"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>`;
                deleteBtn.className = 'p-1 hover:bg-slate-700 rounded';
                deleteBtn.onclick = () => {
                    currentDeleteContributorId = contributor.id;
                    openConfirmationModal(`Delete Contributor "${contributor.name}"?`, "This will delete the contributor globally.", () => {
                        if (currentDeleteContributorId) { deleteContributor(currentDeleteContributorId); }
                    });
                };
                div.appendChild(nameSpan);
                div.appendChild(deleteBtn);
                existingContributorsListEl.appendChild(div);
            });
        }
        function openContributorManagementModal() {
            renderContributorsInManagementModal();
            contributorManagementModalEl.classList.remove('hidden');
        }
        function closeContributorManagementModal() {
            contributorManagementModalEl.classList.add('hidden');
        }

        function createEntryCard(entry) {
            const card = document.createElement('div');
            card.className = 'bg-slate-800 rounded-xl shadow-xl overflow-hidden transform hover:scale-105 transition-transform duration-200 flex flex-col';
            let tvScreenerInfo = '';
            if (entry.type === "TV Show") { if (entry.screenerRequested) { tvScreenerInfo += `Requested ${entry.screenerRequestedDate ? '(' + formatDate(entry.screenerRequestedDate) + ')' : ''}`; } if (entry.screenerReceived) { tvScreenerInfo += `${tvScreenerInfo ? ' / ' : ''}Received ${entry.screenerReceivedDate ? '(' + formatDate(entry.screenerReceivedDate) + ')' : ''}`; } if (!tvScreenerInfo) tvScreenerInfo = 'N/A'; }
            let filmPressScreeningInfo = '';
            if (entry.type === "Film") { if (entry.pressScreeningAttendanceRequested) { filmPressScreeningInfo += `Requested ${entry.pressScreeningRequestDate ? '(' + formatDate(entry.pressScreeningRequestDate) + ')' : ''}`; } if (entry.pressScreeningSecured) { filmPressScreeningInfo += `${filmPressScreeningInfo ? ' / ' : ''}Secured ${entry.pressScreeningDateTime ? '(' + formatDate(entry.pressScreeningDateTime) + ')' : ''}`; } if (!filmPressScreeningInfo) filmPressScreeningInfo = 'N/A'; }
            const typeIndicator = entry.type === "Film" ? `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2 h-4 w-4 text-purple-400"><rect x="2" y="2" width="20" height="20" rx="2.18" ry="2.18"></rect><line x1="7" y1="2" x2="7" y2="22"></line><line x1="17" y1="2" x2="17" y2="22"></line><line x1="2" y1="12" x2="22" y2="12"></line><line x1="2" y1="7" x2="7" y2="7"></line><line x1="2" y1="17" x2="7" y2="17"></line><line x1="17" y1="17" x2="22" y2="17"></line><line x1="17" y1="7" x2="22" y2="7"></line></svg>` : `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2 h-4 w-4 text-sky-500"><rect width="20" height="15" x="2" y="7" rx="2" ry="2"></rect><polyline points="17 2 12 7 7 2"></polyline></svg>`;
            let trailerHTML = '';
            const youtubeVideoId = getYouTubeVideoId(entry.trailerLink);
            if (youtubeVideoId) { trailerHTML = `<div class="trailer-thumbnail-container" data-video-id="${youtubeVideoId}"><img src="https://i.ytimg.com/vi/${youtubeVideoId}/mqdefault.jpg" alt="Trailer thumbnail for ${entry.title}" onerror="this.style.display='none'; this.parentElement.innerHTML = '<p class=\\'text-xs text-slate-400 p-2\\'>Trailer thumbnail unavailable.</p>';"><div class="play-button-overlay"><svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"></path></svg></div></div>`; }
            else if (entry.trailerLink) { trailerHTML = `<p class="text-xs text-slate-300 mb-3"><span class="font-semibold text-sky-300">Trailer:</span> <a href="${entry.trailerLink}" target="_blank" rel="noopener noreferrer" class="text-sky-400 hover:text-sky-300 underline">Watch Trailer</a></p>`; }
            card.innerHTML = `<div class="p-6 flex-grow">${trailerHTML}<div class="flex justify-between items-start mb-2"><h2 class="text-2xl font-semibold text-sky-400">${entry.title}</h2><span class="text-xs uppercase font-semibold px-2 py-1 rounded-full ${entry.type === 'Film' ? 'bg-purple-500 text-purple-100' : 'bg-sky-500 text-sky-100'}">${entry.type}</span></div><p class="text-sm text-slate-400 mb-1 flex items-center">${typeIndicator}${entry.networkPlatform || 'N/A'}</p><p class="text-sm text-slate-400 mb-1 flex items-center"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2 h-4 w-4 text-sky-500"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"></rect><line x1="16" x2="16" y1="2" y2="6"></line><line x1="8" x2="8" y1="2" y2="6"></line><line x1="3" x2="21" y1="10" y2="10"></line></svg>${formatDate(entry.premiereDate)}</p><p class="text-sm text-slate-400 mb-3 flex items-center"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-2 h-4 w-4 text-sky-500"><path d="M12 2H2v10l9.29 9.29a2.82 2.82 0 0 0 3.99-.01L22 13.99a2.82 2.82 0 0 0-.01-3.99L12 2z"></path><path d="M7 7h.01"></path></svg>${entry.genre || 'N/A'}</p><div class="space-y-1 text-xs text-slate-300 mb-4"><p><span class="font-semibold text-sky-300">Status:</span> ${entry.reviewStatus}</p><p><span class="font-semibold text-sky-300">Priority:</span> ${entry.coveragePriority}</p>${entry.type === "TV Show" ? `<p><span class="font-semibold text-sky-300">Screener:</span> ${tvScreenerInfo}</p>` : ''}${entry.type === "Film" ? `<p><span class="font-semibold text-sky-300">Press Screening:</span> ${filmPressScreeningInfo}</p>` : ''}${entry.assignedTo ? `<p><span class="font-semibold text-sky-300">Assigned:</span> ${entry.assignedTo}</p>` : ''}${entry.reviewProducer ? `<p><span class="font-semibold text-sky-300">Producer:</span> ${entry.reviewProducer}</p>` : ''}${entry.contributors && entry.contributors.length > 0 ? `<p><span class="font-semibold text-sky-300">Contributors:</span> ${entry.contributors.join(', ')}</p>` : ''}${entry.notes ? `<p class="italic truncate" title="${entry.notes}"><span class="font-semibold text-sky-300">Notes:</span> ${entry.notes}</p>` : ''}${entry.youtubeLink ? `<a href="${entry.youtubeLink}" target="_blank" rel="noopener noreferrer" class="text-red-400 hover:text-red-300 flex items-center"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-1 h-4 w-4"><path d="M2.5 17a24.12 24.12 0 0 1 0-10 2 2 0 0 1 1.4-1.4 49.56 49.56 0 0 1 16.2 0A2 2 0 0 1 21.5 7a24.12 24.12 0 0 1 0 10 2 2 0 0 1-1.4 1.4 49.55 49.55 0 0 1-16.2 0A2 2 0 0 1 2.5 17"></path><path d="m10 15 5-3-5-3z"></path></svg> View Review</a>` : ''}</div></div><div class="bg-slate-700 p-4 flex justify-end gap-3"><button class="edit-btn text-yellow-400 hover:text-yellow-300 transition-colors p-2 rounded-md hover:bg-slate-600" data-id="${entry.id}"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg></button><button class="delete-btn text-red-400 hover:text-red-300 transition-colors p-2 rounded-md hover:bg-slate-600" data-id="${entry.id}" data-title="${entry.title}"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg></button></div>`;
            const editBtn = card.querySelector('.edit-btn');
            const deleteBtn = card.querySelector('.delete-btn');
            const canEdit = currentUserRole === 'admin' || currentUserRole === 'editor';
            if (canEdit) { editBtn.addEventListener('click', () => handleEditEntry(entry.id)); }
            else { editBtn.disabled = true; editBtn.classList.add('opacity-25', 'cursor-not-allowed'); }
            if (currentUserRole === 'admin') { deleteBtn.addEventListener('click', () => { currentDeleteEntryId = entry.id; openConfirmationModal(`Delete "${entry.title}"?`, "This is permanent and cannot be undone.", () => { if (currentDeleteEntryId) { handleDeleteEntry(currentDeleteEntryId); } }); }); }
            else { deleteBtn.disabled = true; deleteBtn.classList.add('opacity-25', 'cursor-not-allowed'); }
            const thumbnailContainer = card.querySelector('.trailer-thumbnail-container'); if (thumbnailContainer) { thumbnailContainer.addEventListener('click', () => { const videoId = thumbnailContainer.dataset.videoId; thumbnailContainer.innerHTML = `<div class="embedded-trailer"><iframe src="https://www.youtube.com/embed/${videoId}?autoplay=1&modestbranding=1&rel=0" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe></div>`; }, { once: true }); }
            return card;
        }

        function renderEntries() {
            showsGridEl.innerHTML = '';
            const searchTerm = searchTermInputEl.value.toLowerCase();
            const typeFilter = filterTypeSelectEl.value;
            const statusFilter = filterStatusSelectEl.value;
            const priorityFilter = filterPrioritySelectEl.value;
            const assignedToFilter = filterAssignedToSelectEl.value;
            const pressScreeningSecuredFilter = filterPressScreeningSecuredEl.value;
            const sortBy = sortOrderSelectEl.value;
            const dateGranularity = dateFilterGranularityEl.value;
            const rawReferenceDate = dateFilterReferenceDateEl.value;
            const dateRelation = dateFilterRelationEl.value;
            let filterStartDate = null;
            let filterEndDate = null;
            if (dateGranularity !== "none" && rawReferenceDate) {
                const refDate = new Date(rawReferenceDate + "T00:00:00");
                if (!isNaN(refDate.getTime())) {
                    if (dateGranularity === "day") { filterStartDate = new Date(refDate); filterEndDate = new Date(refDate); }
                    else if (dateGranularity === "week") { filterStartDate = getStartOfWeek(new Date(refDate)); filterEndDate = getEndOfWeek(new Date(refDate)); }
                    else if (dateGranularity === "month") { filterStartDate = new Date(refDate.getFullYear(), refDate.getMonth(), 1); filterEndDate = new Date(refDate.getFullYear(), refDate.getMonth() + 1, 0); }
                    else if (dateGranularity === "quarter") { const quarter = Math.floor(refDate.getMonth() / 3); filterStartDate = new Date(refDate.getFullYear(), quarter * 3, 1); filterEndDate = new Date(refDate.getFullYear(), quarter * 3 + 3, 0); }
                    else if (dateGranularity === "year") { filterStartDate = new Date(refDate.getFullYear(), 0, 1); filterEndDate = new Date(refDate.getFullYear(), 11, 31); }
                    if (filterStartDate) filterStartDate.setHours(0, 0, 0, 0);
                    if (filterEndDate) filterEndDate.setHours(23, 59, 59, 999);
                }
            }
            let filteredEntries = allEntries.filter(entry => {
                const matchesSearchTerm = (entry.title?.toLowerCase().includes(searchTerm) || entry.networkPlatform?.toLowerCase().includes(searchTerm) || entry.genre?.toLowerCase().includes(searchTerm));
                const matchesType = typeFilter ? entry.type === typeFilter : true;
                const matchesStatus = statusFilter ? entry.reviewStatus === statusFilter : true;
                const matchesPriority = priorityFilter ? entry.coveragePriority === priorityFilter : true;
                const matchesAssignedTo = assignedToFilter ? entry.assignedTo === assignedToFilter : true;
                let matchesPressScreening = true;
                if (pressScreeningSecuredFilter) { if (entry.type === "Film") { matchesPressScreening = pressScreeningSecuredFilter === "yes" ? entry.pressScreeningSecured === true : entry.pressScreeningSecured === false; } else { matchesPressScreening = false; } }
                let matchesDateFilter = true;
                if (dateGranularity !== "none" && filterStartDate && filterEndDate && entry.premiereDate) {
                    try {
                        const entryPremiereDate = new Date(entry.premiereDate + "T00:00:00");
                        entryPremiereDate.setHours(0, 0, 0, 0);
                        if (dateRelation === "during") { matchesDateFilter = entryPremiereDate >= filterStartDate && entryPremiereDate <= filterEndDate; }
                        else if (dateRelation === "before") { matchesDateFilter = entryPremiereDate < filterStartDate; }
                        else if (dateRelation === "after") { matchesDateFilter = entryPremiereDate > filterEndDate; }
                    } catch (e) { matchesDateFilter = false; }
                }
                return matchesSearchTerm && matchesType && matchesStatus && matchesPriority && matchesAssignedTo && matchesPressScreening && matchesDateFilter;
            });
            filteredEntries.sort((a, b) => {
                if (sortBy === 'title') { return (a.title || "").localeCompare(b.title || ""); }
                else if (sortBy === 'pressScreeningDateTime') { const dateA = a.pressScreeningDateTime ? new Date(a.pressScreeningDateTime) : null; const dateB = b.pressScreeningDateTime ? new Date(b.pressScreeningDateTime) : null; if (!dateA && !dateB) return 0; if (!dateA) return 1; if (!dateB) return -1; return dateA - dateB; }
                else { const dateA = a.premiereDate ? new Date(a.premiereDate) : null; const dateB = b.premiereDate ? new Date(b.premiereDate) : null; if (!dateA && !dateB) return 0; if (!dateA) return 1; if (!dateB) return -1; return dateA - dateB; }
            });
            if (filteredEntries.length === 0) {
                noShowsMessageEl.classList.remove('hidden');
                noShowsMessageEl.querySelector('p.text-xl').textContent = allEntries.length > 0 ? "No entries match your current filters." : "No entries added yet.";
            } else {
                noShowsMessageEl.classList.add('hidden');
            }
            filteredEntries.forEach(entry => {
                // BUG FIX: Pass the currentUserRole to the createEntryCard function
                showsGridEl.appendChild(createEntryCard(entry, currentUserRole));
            });
            updateAssignedToFilterOptions();
        }

        function updateAssignedToFilterOptions() {
            const assignedToList = [...new Set(allEntries.map(entry => entry.assignedTo).filter(Boolean))].sort();
            populateDropdown(filterAssignedToSelectEl, assignedToList, true, "All Assigned");
        }

        // --- Initialization ---
        function initializeAppUI() {
            document.getElementById('currentYear').textContent = new Date().getFullYear();
            populateDropdown(document.getElementById('reviewStatus'), reviewStatuses, false);
            populateDropdown(document.getElementById('coveragePriority'), coveragePriorities, false);
            populateDropdown(filterStatusSelectEl, reviewStatuses, true, "All Statuses");
            populateDropdown(filterPrioritySelectEl, coveragePriorities, true, "All Priorities");
            referenceDateInputContainerEl.style.display = 'none';
            dateFilterReferenceDateEl.valueAsDate = new Date();
            // Role-based UI controls
            if (currentUserRole === 'admin') {
                manageContributorsBtnEl.style.display = 'flex';
                bulkAddBtnEl.style.display = 'flex';
                addShowBtnEl.style.display = 'flex';
            } else if (currentUserRole === 'editor') {
                manageContributorsBtnEl.style.display = 'none';
                bulkAddBtnEl.style.display = 'none';
                addShowBtnEl.style.display = 'flex';
            } else { // viewer
                manageContributorsBtnEl.style.display = 'none';
                bulkAddBtnEl.style.display = 'none';
                addShowBtnEl.style.display = 'none';
            }
        }

        // --- Event Listeners ---
        addShowBtnEl.addEventListener('click', () => openModal());
        cancelModalBtnEl.addEventListener('click', closeModal);
        bulkAddBtnEl.addEventListener('click', openBulkAddModal);
        closeBulkAddModalBtnEl.addEventListener('click', closeBulkAddModal);
        importBulkDataBtnEl.addEventListener('click', handleBulkAdd);
        exportDataBtnEl.addEventListener('click', handleExportData);
        searchTermInputEl.addEventListener('input', renderEntries);
        filterTypeSelectEl.addEventListener('change', renderEntries);
        filterStatusSelectEl.addEventListener('change', renderEntries);
        filterPrioritySelectEl.addEventListener('change', renderEntries);
        filterAssignedToSelectEl.addEventListener('change', renderEntries);
        filterPressScreeningSecuredEl.addEventListener('change', renderEntries);
        sortOrderSelectEl.addEventListener('change', renderEntries);
        dateFilterGranularityEl.addEventListener('change', renderEntries);
        dateFilterReferenceDateEl.addEventListener('change', renderEntries);
        dateFilterRelationEl.addEventListener('change', renderEntries);
        clearDateFilterBtnEl.addEventListener('click', () => { dateFilterGranularityEl.value = "none"; dateFilterReferenceDateEl.value = ""; dateFilterRelationEl.value = "during"; referenceDateInputContainerEl.style.display = 'none'; renderEntries(); });
        dateFilterGranularityEl.addEventListener('change', () => { referenceDateInputContainerEl.style.display = dateFilterGranularityEl.value === 'none' ? 'none' : 'block'; });
        cancelConfirmBtnEl.addEventListener('click', closeConfirmationModal);
        manageContributorsBtnEl.addEventListener('click', openContributorManagementModal);
        addContributorBtnEl.addEventListener('click', addContributor);
        closeContributorModalBtnEl.addEventListener('click', closeContributorManagementModal);
        document.getElementById('entryType').addEventListener('change', (e) => { toggleModalSpecificFields(e.target.value); });
        document.getElementById('screenerRequested').addEventListener('change', (e) => { screenerRequestedDateContainerEl.classList.toggle('hidden', !e.target.checked); if (!e.target.checked) document.getElementById('screenerRequestedDate').value = ''; });
        document.getElementById('screenerReceived').addEventListener('change', (e) => { screenerReceivedDateContainerEl.classList.toggle('hidden', !e.target.checked); if (!e.target.checked) document.getElementById('screenerReceivedDate').value = ''; });
        document.getElementById('pressScreeningAttendanceRequested').addEventListener('change', (e) => { pressScreeningRequestDateContainerEl.classList.toggle('hidden', !e.target.checked); if (!e.target.checked) document.getElementById('pressScreeningRequestDate').value = ''; });
        document.getElementById('pressScreeningSecured').addEventListener('change', (e) => { pressScreeningDateTimeContainerEl.classList.toggle('hidden', !e.target.checked); if (!e.target.checked) document.getElementById('pressScreeningDateTime').value = ''; });
    </script>
</body>

</html>